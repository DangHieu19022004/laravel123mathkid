<?php

namespace App\Http\Controllers\Games;

use Random\RandomException;

class ThuThachDoLuongController extends AbstractGroupGameController
{
    protected string $group = 'thu_thach_do_luong';

    // 1. Th·ªùi Gian N√¢ng Cao
    public function advancedTimeGame()
    {
        $questions = [
            [
                'level'       => 1,
                'scenario'    => 'M·ªôt chuy·∫øn xe kh·ªüi h√†nh l√∫c 8:30 v√† ƒë·∫øn n∆°i l√∫c 10:15. H·ªèi chuy·∫øn xe ƒëi m·∫•t bao l√¢u?',
                'start_time'  => '8:30',
                'end_time'    => '10:15',
                'answer_unit' => 'ph√∫t'
            ],
            [
                'level'       => 2,
                'scenario'    => 'M·ªôt bu·ªïi h·ªçc k√©o d√†i 2 gi·ªù 15 ph√∫t, b·∫Øt ƒë·∫ßu t·ª´ 13:45. H·ªèi bu·ªïi h·ªçc k·∫øt th√∫c l√∫c m·∫•y gi·ªù?',
                'start_time'  => '13:45',
                'duration'    => 135,
                'answer_unit' => 'time'
            ],
            [
                'level'       => 3,
                'scenario'    => 'M·ªôt cu·ªôc h·ªçp b·∫Øt ƒë·∫ßu l√∫c 9:30 v√† k·∫øt th√∫c l√∫c 11:45. T√≠nh th·ªùi gian cu·ªôc h·ªçp?',
                'start_time'  => '9:30',
                'end_time'    => '11:45',
                'answer_unit' => 'ph√∫t'
            ],
            [
                'level'       => 4,
                'scenario'    => 'M·ªôt tr·∫≠n b√≥ng ƒë√° k√©o d√†i 2 gi·ªù 30 ph√∫t (bao g·ªìm gi·ªù gi·∫£i lao), b·∫Øt ƒë·∫ßu l√∫c 19:00. H·ªèi tr·∫≠n ƒë·∫•u k·∫øt th√∫c l√∫c m·∫•y gi·ªù?',
                'start_time'  => '19:00',
                'duration'    => 150,
                'answer_unit' => 'time'
            ],
            [
                'level'       => 5,
                'scenario'    => 'M·ªôt chuy·∫øn bay xu·∫•t ph√°t l√∫c 23:45 v√† h·∫° c√°nh l√∫c 5:30 s√°ng h√¥m sau. H·ªèi chuy·∫øn bay k√©o d√†i bao l√¢u?',
                'start_time'  => '23:45',
                'end_time'    => '5:30',
                'next_day'    => true,
                'answer_unit' => 'ph√∫t'
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.advanced_time', ['questions' => $questions]);
    }

    // 2. C√¢n T√°o C√¢n Cam
    public function fruitWeighingGame()
    {
        $questions = [
            [
                'leftFruit'  => ['type' => 'apple', 'weight' => 150],
                'rightFruit' => ['type' => 'orange', 'weight' => 130],
                'units'      => 'g'
            ],
            [
                'leftFruit'  => ['type' => 'apple', 'weight' => 0.2],
                'rightFruit' => ['type' => 'orange', 'weight' => 0.18],
                'units'      => 'kg'
            ],
            [
                'leftFruit'  => ['type' => 'apple', 'weight' => 180],
                'rightFruit' => ['type' => 'orange', 'weight' => 200],
                'units'      => 'g'
            ],
            [
                'leftFruit'  => ['type' => 'apple', 'weight' => 0.25],
                'rightFruit' => ['type' => 'orange', 'weight' => 0.22],
                'units'      => 'kg'
            ],
            [
                'leftFruit'  => ['type' => 'apple', 'weight' => 220],
                'rightFruit' => ['type' => 'orange', 'weight' => 180],
                'units'      => 'g'
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.can_tao_cam', ['questions' => $questions]);
    }

    // 3. Chuy·ªÉn ƒê·ªïi ƒê∆°n V·ªã
    public function unitConversionGame()
    {
        $questions = [
            [
                'value'    => 2000,
                'fromUnit' => 'm',
                'toUnit'   => 'km',
                'options'  => [1, 2, 3, 4]
            ],
            [
                'value'    => 3.5,
                'fromUnit' => 'kg',
                'toUnit'   => 'g',
                'options'  => [3500, 350, 35, 3050]
            ],
            [
                'value'    => 4500,
                'fromUnit' => 'ml',
                'toUnit'   => 'l',
                'options'  => [4.5, 45, 0.45, 450]
            ],
            [
                'value'    => 7.2,
                'fromUnit' => 'km',
                'toUnit'   => 'm',
                'options'  => [720, 7200, 72, 7020]
            ],
            [
                'value'    => 2500,
                'fromUnit' => 'g',
                'toUnit'   => 'kg',
                'options'  => [2.5, 25, 0.25, 250]
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.chuyen_doi_don_vi', ['questions' => $questions]);
    }

    // 4. B·∫£ng Quy ƒê·ªïi
    public function conversionTableGame()
    {
        $questions = [
            [
                'type'        => 'length',
                'values'      => [
                    ['value' => 2, 'unit' => 'km'],
                    ['value' => 3500, 'unit' => 'm'],
                    ['value' => 4200, 'unit' => 'm'],
                    ['value' => 1.8, 'unit' => 'km']
                ],
                'target_unit' => 'm'
            ],
            [
                'type'        => 'weight',
                'values'      => [
                    ['value' => 1.5, 'unit' => 'kg'],
                    ['value' => 2800, 'unit' => 'g'],
                    ['value' => 3.2, 'unit' => 'kg'],
                    ['value' => 1600, 'unit' => 'g']
                ],
                'target_unit' => 'g'
            ],
            [
                'type'        => 'volume',
                'values'      => [
                    ['value' => 2.5, 'unit' => 'l'],
                    ['value' => 1800, 'unit' => 'ml'],
                    ['value' => 3400, 'unit' => 'ml'],
                    ['value' => 4.2, 'unit' => 'l']
                ],
                'target_unit' => 'ml'
            ],
            [
                'type'        => 'mixed',
                'values'      => [
                    ['value' => 1.2, 'unit' => 'km'],
                    ['value' => 2.5, 'unit' => 'kg'],
                    ['value' => 3000, 'unit' => 'ml'],
                    ['value' => 4500, 'unit' => 'm']
                ],
                'conversions' => [
                    'km' => ['to' => 'm', 'multiplier' => 1000],
                    'kg' => ['to' => 'g', 'multiplier' => 1000],
                    'l'  => ['to' => 'ml', 'multiplier' => 1000]
                ]
            ],
            [
                'type'        => 'mixed',
                'values'      => [
                    ['value' => 2800, 'unit' => 'g'],
                    ['value' => 3.6, 'unit' => 'km'],
                    ['value' => 4.2, 'unit' => 'l'],
                    ['value' => 5500, 'unit' => 'm']
                ],
                'conversions' => [
                    'g'  => ['to' => 'kg', 'multiplier' => 0.001],
                    'm'  => ['to' => 'km', 'multiplier' => 0.001],
                    'ml' => ['to' => 'l', 'multiplier' => 0.001]
                ]
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.conversion_table', ['questions' => $questions]);
    }

    // 5. So S√°nh Kho·∫£ng C√°ch
    public function distanceComparisonGame()
    {
        $questions = [
            [
                'distances' => [
                    ['value' => 1.5, 'unit' => 'km'],
                    ['value' => 1200, 'unit' => 'm'],
                    ['value' => 1800, 'unit' => 'm']
                ]
            ],
            [
                'distances' => [
                    ['value' => 2.5, 'unit' => 'km'],
                    ['value' => 2800, 'unit' => 'm'],
                    ['value' => 2300, 'unit' => 'm']
                ]
            ],
            [
                'distances' => [
                    ['value' => 3000, 'unit' => 'm'],
                    ['value' => 3.2, 'unit' => 'km'],
                    ['value' => 2900, 'unit' => 'm']
                ]
            ],
            [
                'distances' => [
                    ['value' => 4.5, 'unit' => 'km'],
                    ['value' => 4800, 'unit' => 'm'],
                    ['value' => 4600, 'unit' => 'm']
                ]
            ],
            [
                'distances' => [
                    ['value' => 5200, 'unit' => 'm'],
                    ['value' => 5.1, 'unit' => 'km'],
                    ['value' => 5300, 'unit' => 'm']
                ]
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.distance-comparison', ['questions' => $questions]);
    }

    // 6. ƒêo ƒê·ªô D√†i
    public function lengthMeasurementGame()
    {
        $questions = $this->getLengthQuestions();
        return view('games.lop4.thu_thach_do_luong.length_measurement', ['questions' => $questions]);
    }

    private function getLengthQuestions(): array
    {
        $allObjects = [
            ['object' => 'b√∫t ch√¨', 'emoji' => '‚úèÔ∏è', 'length' => 15, 'unit' => 'cm'],
            ['object' => 'quy·ªÉn v·ªü', 'emoji' => 'üìì', 'length' => 25, 'unit' => 'cm'],
            ['object' => 'th∆∞·ªõc k·∫ª', 'emoji' => 'üìè', 'length' => 30, 'unit' => 'cm'],
            ['object' => 'd√¢y nh·∫£y', 'emoji' => 'ü™¢', 'length' => 2.5, 'unit' => 'm'],
            ['object' => 'ƒëi·ªán tho·∫°i', 'emoji' => 'üì±', 'length' => 15, 'unit' => 'cm'],
            ['object' => 'h·ªôp b√∫t', 'emoji' => 'üñäÔ∏è', 'length' => 20, 'unit' => 'cm'],
            ['object' => 'chai n∆∞·ªõc', 'emoji' => 'üß¥', 'length' => 22, 'unit' => 'cm'],
            ['object' => 'b√†n h·ªçc', 'emoji' => 'ü™ë', 'length' => 1.2, 'unit' => 'm'],
            ['object' => 't·ªù gi·∫•y A4', 'emoji' => 'üìÑ', 'length' => 29.7, 'unit' => 'cm'],
            ['object' => 'c·ª≠a l·ªõp h·ªçc', 'emoji' => 'üö™', 'length' => 2, 'unit' => 'm'],
        ];
        $questions  = [];
        $preset     = [
            // 5 c√¢u h·ªèi m·∫´u, m·ªói c√¢u 2-3 object, tr·ªôn ƒë∆°n v·ªã
            [0, 2, 3], // b√∫t ch√¨, th∆∞·ªõc k·∫ª, d√¢y nh·∫£y
            [1, 4],    // quy·ªÉn v·ªü, ƒëi·ªán tho·∫°i
            [5, 6, 8], // h·ªôp b√∫t, chai n∆∞·ªõc, t·ªù gi·∫•y A4
            [7, 9],    // b√†n h·ªçc, c·ª≠a l·ªõp h·ªçc
            [2, 5, 1], // th∆∞·ªõc k·∫ª, h·ªôp b√∫t, quy·ªÉn v·ªü
        ];
        foreach ($preset as $idxs) {
            $objects = [];
            foreach ($idxs as $i) {
                $o              = $allObjects[$i];
                $o['length_cm'] = $o['unit'] === 'm' ? $o['length'] * 100 : $o['length'];
                $objects[]      = $o;
            }
            $type         = rand(0, 1) ? 'max' : 'min';
            $answer_index = 0;
            if ($type === 'max') {
                $max = max(array_column($objects, 'length_cm'));
                foreach ($objects as $i => $o) {
                    if ($o['length_cm'] == $max) {
                        $answer_index = $i;
                    }
                }
            } else {
                $min = min(array_column($objects, 'length_cm'));
                foreach ($objects as $i => $o) {
                    if ($o['length_cm'] == $min) {
                        $answer_index = $i;
                    }
                }
            }
            $questions[] = [
                'objects'      => $objects,
                'type'         => $type,
                'answer_index' => $answer_index
            ];
        }
        return $questions;
    }

    // 7. B·∫•m Gi·ªù Ch√≠nh X√°c
    public function precisionTimingGame()
    {
        $questions = [
            [
                'target'       => 10,
                'allowedError' => 0.5,
                'description'  => 'B·∫•m gi·ªù ƒë√∫ng 10 gi√¢y'
            ],
            [
                'target'       => 20,
                'allowedError' => 0.5,
                'description'  => 'B·∫•m gi·ªù ƒë√∫ng 20 gi√¢y'
            ],
            [
                'target'       => 30,
                'allowedError' => 0.7,
                'description'  => 'B·∫•m gi·ªù ƒë√∫ng 30 gi√¢y'
            ],
            [
                'target'       => 45,
                'allowedError' => 1,
                'description'  => 'B·∫•m gi·ªù ƒë√∫ng 45 gi√¢y'
            ],
            [
                'target'       => 60,
                'allowedError' => 1,
                'description'  => 'B·∫•m gi·ªù ƒë√∫ng 1 ph√∫t'
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.precision_timing', ['questions' => $questions]);
    }

    // 8. Th·ªùi Gian Phi√™u L∆∞u (refactor: tr·∫£ v·ªÅ danh s√°ch nhi·ªÅu c√¢u h·ªèi cho client x·ª≠ l√Ω)
    public function timeAdventureGame()
    {
        $questions = [
            [
                'startTime' => '08:30',
                'duration'  => 45,
                'type'      => 'minutes',
                'endTime'   => '09:15',
                'options'   => ['09:00', '09:15', '09:45', '08:45']
            ],
            [
                'startTime' => '10:15',
                'duration'  => 2,
                'type'      => 'hours',
                'endTime'   => '12:15',
                'options'   => ['12:15', '11:45', '13:15', '10:45']
            ],
            [
                'startTime' => '14:20',
                'duration'  => 90,
                'type'      => 'minutes',
                'endTime'   => '15:50',
                'options'   => ['15:20', '15:50', '16:00', '14:50']
            ],
            [
                'startTime' => '09:45',
                'duration'  => 3.5,
                'type'      => 'hours',
                'endTime'   => '13:15',
                'options'   => ['13:15', '12:45', '14:15', '10:15']
            ],
            [
                'startTime' => '16:30',
                'duration'  => 150,
                'type'      => 'minutes',
                'endTime'   => '19:00',
                'options'   => ['18:30', '19:00', '17:00', '19:30']
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.thoi_gian_phieu_luu', ['questions' => $questions]);
    }

    // 9. So S√°nh Th·ªùi Gian
    public function timeComparisonGame()
    {
        $questions = [
            [
                'times' => [
                    ['hours' => 1, 'minutes' => 30],
                    ['hours' => 2, 'minutes' => 0],
                    ['hours' => 1, 'minutes' => 45]
                ]
            ],
            [
                'times' => [
                    ['hours' => 2, 'minutes' => 15],
                    ['hours' => 2, 'minutes' => 45],
                    ['hours' => 2, 'minutes' => 30]
                ]
            ],
            [
                'times' => [
                    ['hours' => 3, 'minutes' => 0],
                    ['hours' => 2, 'minutes' => 55],
                    ['hours' => 3, 'minutes' => 5]
                ]
            ],
            [
                'times' => [
                    ['hours' => 4, 'minutes' => 30],
                    ['hours' => 4, 'minutes' => 15],
                    ['hours' => 4, 'minutes' => 45]
                ]
            ],
            [
                'times' => [
                    ['hours' => 5, 'minutes' => 25],
                    ['hours' => 5, 'minutes' => 30],
                    ['hours' => 5, 'minutes' => 15]
                ]
            ]
        ];
        return view('games.lop4.thu_thach_do_luong.time_comparison', ['questions' => $questions]);
    }

    // 10. ∆Ø·ªõc L∆∞·ª£ng Kh·ªëi L∆∞·ª£ng
    public function weightEstimationGame()
    {
        $questions = $this->generateCompareWeightQuestions();
        return view('games.lop4.thu_thach_do_luong.weight_estimation', ['questions' => $questions]);
    }

    private function generateCompareWeightQuestions(): array
    {
        $allObjects = [
            ['object' => 'qu·∫£ t√°o', 'emoji' => 'üçé', 'weight' => 150, 'unit' => 'g'],
            ['object' => 't√∫i g·∫°o nh·ªè', 'emoji' => 'üçö', 'weight' => 1, 'unit' => 'kg'],
            ['object' => 'c·∫∑p s√°ch', 'emoji' => 'üéí', 'weight' => 2.5, 'unit' => 'kg'],
            ['object' => 'xe ƒë·∫°p', 'emoji' => 'üö≤', 'weight' => 12, 'unit' => 'kg'],
            ['object' => 'bao g·∫°o l·ªõn', 'emoji' => 'üß∫', 'weight' => 25, 'unit' => 'kg'],
            ['object' => 'quy·ªÉn s√°ch', 'emoji' => 'üìï', 'weight' => 300, 'unit' => 'g'],
            ['object' => 'chai n∆∞·ªõc', 'emoji' => 'üß¥', 'weight' => 500, 'unit' => 'g'],
            ['object' => 'b√∫t ch√¨', 'emoji' => '‚úèÔ∏è', 'weight' => 10, 'unit' => 'g'],
            ['object' => 'h·ªôp s·ªØa', 'emoji' => 'ü•õ', 'weight' => 180, 'unit' => 'g'],
            ['object' => 'qu·∫£ cam', 'emoji' => 'üçä', 'weight' => 200, 'unit' => 'g'],
        ];
        $questions  = [];
        for ($i = 0; $i < 5; $i++) {
            $objects = $allObjects;
            shuffle($objects);
            $num     = rand(2, 3);
            $objects = array_slice($objects, 0, $num);
            foreach ($objects as &$o) {
                if ($o['unit'] === 'kg') {
                    $o['weight_g'] = $o['weight'] * 1000;
                } else {
                    $o['weight_g'] = $o['weight'];
                }
            }
            unset($o);
            $type         = rand(0, 1) ? 'max' : 'min';
            $answer_index = 0;
            if ($type === 'max') {
                $max = max(array_column($objects, 'weight_g'));
                foreach ($objects as $j => $o) {
                    if ($o['weight_g'] == $max) {
                        $answer_index = $j;
                    }
                }
            } else {
                $min = min(array_column($objects, 'weight_g'));
                foreach ($objects as $j => $o) {
                    if ($o['weight_g'] == $min) {
                        $answer_index = $j;
                    }
                }
            }
            $questions[] = [
                'objects'      => array_map(function ($o) {
                    unset($o['weight_g']);
                    return $o;
                }, $objects),
                'type'         => $type,
                'answer_index' => $answer_index
            ];
        }
        return $questions;
    }

    // 11. S·∫Øp X·∫øp Kh·ªëi L∆∞·ª£ng
    public function weightSortingGame()
    {
        $questions = $this->generateWeightSortingQuestions();
        return view('games.lop4.thu_thach_do_luong.weight_sorting', ['questions' => $questions]);
    }

    private function generateWeightSortingQuestions(): array
    {
        return [
            [
                'weights' => [
                    ['value' => 500, 'unit' => 'g'],
                    ['value' => 0.7, 'unit' => 'kg'],
                    ['value' => 300, 'unit' => 'g'],
                    ['value' => 0.9, 'unit' => 'kg']
                ]
            ],
            [
                'weights' => [
                    ['value' => 1.2, 'unit' => 'kg'],
                    ['value' => 900, 'unit' => 'g'],
                    ['value' => 1500, 'unit' => 'g'],
                    ['value' => 0.8, 'unit' => 'kg']
                ]
            ],
            [
                'weights' => [
                    ['value' => 2000, 'unit' => 'g'],
                    ['value' => 1.5, 'unit' => 'kg'],
                    ['value' => 2.5, 'unit' => 'kg'],
                    ['value' => 1800, 'unit' => 'g']
                ]
            ],
            [
                'weights' => [
                    ['value' => 3.2, 'unit' => 'kg'],
                    ['value' => 2800, 'unit' => 'g'],
                    ['value' => 3500, 'unit' => 'g'],
                    ['value' => 2.9, 'unit' => 'kg']
                ]
            ],
            [
                'weights' => [
                    ['value' => 4500, 'unit' => 'g'],
                    ['value' => 5, 'unit' => 'kg'],
                    ['value' => 4.2, 'unit' => 'kg'],
                    ['value' => 3800, 'unit' => 'g']
                ]
            ]
        ];
    }
}
